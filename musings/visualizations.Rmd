---
title: "Visualizations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualizations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`epipredict` supports visualizations features that are a part of COVIDcast.
However, it is not intended for
those who use third-party data visualization software such as Power BI and
Tableau. Despite that, visualizations go alongside cmu-delphi's covidcast
library.

For the first example, we are tracking the cumulative number of COVID cases
by state up until 2021-12-31.

```{r}
library(covidcast)
library(dplyr)
x <- case_death_rate_subset %>%
  filter(!(geo_value %in% c("as","cm","gu","mp","vi")),
         time_value <= "2021-12-31") %>%
  group_by(geo_value) %>%
  summarize(value = sum(case_rate) / 1000) %>%
  mutate(time_value = as.Date("2021-12-31"))

cc <- as.covidcast_signal(x,
                          geo_type = "state",
                          data_source = "covid-tracking",
                          signal = "cumulative_case_rate_thousands")

plot(cc)
```

We need not use a dataset that's already stored on epipredict or epiprocess.

Keep in mind that only 'county', 'state', 'hrr' and 'msa' are supported
for map plots; 'nation', for example, is NOT supported for a covidcast_signal 
plot. Thus, one would need to load separate packages, etc., do a plot of
something such as a world map or a map of Canada (as not even "province"
is an option for covidcast_signal's geo_type).

```{r}
library(tidyr)
z <- read.csv("https://covid.ourworldindata.org/data/owid-covid-data.csv")

z2 <- z %>%
  select(iso_code,date,total_cases_per_million) %>%
  filter(date <= "2021-12-31") %>%
  drop_na() %>%
  as_tibble()

z_stdev <- z2 %>%
  group_by(iso_code) %>%
  summarize(stdev = sd(total_cases_per_million)) %>%
  filter(stdev > 0)

z_combined <- inner_join(z2,z_stdev)

iso_country_codes <- read.csv("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv") %>%
  select(alpha.2,alpha.3)

z3 <- z2 %>%
  inner_join(iso_country_codes,c("iso_code" = "alpha.3")) %>%
  select(-iso_code,geo_value = alpha.2,
         time_value = date, value = total_cases_per_million) %>%
  mutate(geo_value = tolower(geo_value), time_value = as.Date(time_value))
  
cc <- as.covidcast_signal(z3,
                          geo_type = "nation",
                          data_source = "covid-tracking",
                          signal = "covid_cases_per_million")

plot(cc)

```

If you want to map something such as Canadian provinces,
you will need to install a separate package and use features outside of
covidcast_signal, as those are not recognized geo_type's.

epipredict's epi_df and epi_archive both recognize custom geo_type's, though.
